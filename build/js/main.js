define(["dojo/parser","dojo/dom-attr","dojo/dom-geometry","dojo/on","dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/query","dojo/Deferred","dojo/promise/all","dojo/dom-class","dojo/dom-construct","dijit/registry","esri/domUtils","esri/lang","esri/arcgis/utils","esri/dijit/Popup","application/MapUrlParams","application/sniff","dojo/domReady!"],function(e,i,t,o,a,n,s,r,c,l,h,d,p,g,f,u,m,b,v){return a(null,{config:{},startup:function(i){if(document.documentElement.lang=s.locale,e.parse(),i){if(this.config=i,window.config=i,this.config.sharedThemeConfig&&this.config.sharedThemeConfig.attributes&&this.config.sharedThemeConfig.attributes.theme&&(this.config.theme="light"),this.config.customstyle){var t=document.createElement("style");t.appendChild(document.createTextNode(this.config.customstyle)),document.head.appendChild(t)}v("drawer")?require(["application/Drawer"],n.hitch(this,function(e){this._drawer=new e({borderContainer:"border_container",contentPaneCenter:"cp_center",direction:this.config.i18n.direction,config:this.config,displayDrawer:this.config.legend||this.config.details||this.config.popup_sidepanel||this.config.legendlayers,drawerOpen:this.config.show_panel}),this._drawer.startup(),this._buildMapUI()})):(h.add(document.body,"no-title"),this._buildMapUI())}else{var o=new Error("Main:: Config is not defined");this.reportError(o);(new c).reject(o)}},reportError:function(e){h.remove(document.body,"app-loading"),h.add(document.body,"app-error");var i=document.getElementById("loading_message");i&&(this.config&&this.config.i18n?i.innerHTML=this.config.i18n.map.error+": "+e.message:i.innerHTML=e.message)},_buildMapUI:function(){var e=this.config.itemInfo||this.config.webmap;new b({center:this.config.center||null,extent:this.config.extent||null,level:this.config.level||null,marker:this.config.marker||null,mapSpatialReference:e.itemData.spatialReference,defaultMarkerSymbol:this.config.markerSymbol,defaultMarkerSymbolWidth:this.config.markerSymbolWidth,defaultMarkerSymbolHeight:this.config.markerSymbolHeight,geometryService:this.config.helperServices.geometry.url}).processUrlParams().then(n.hitch(this,function(i){this._createWebMap(e,i)}),n.hitch(this,function(e){this.reportError(e)}))},_addScalebar:function(){var e=new c;return require(["application/sniff!scale?esri/dijit/Scalebar"],n.hitch(this,function(i){if(!i)return void e.resolve();new i({map:this.map,scalebarUnit:this.config.units});e.resolve()})),e.promise},_addZoom:function(){var e=new c;return this.config.home&&this.config.zoom?require(["application/sniff!home?esri/dijit/HomeButton"],n.hitch(this,function(i){if(!i)return void e.resolve();new i({map:this.map},d.create("div",{},r(".esriSimpleSliderIncrementButton")[0],"after")).startup(),e.resolve()})):(h.add(document.body,"no-home"),e.resolve()),e.promise},_addLayerList:function(){var e=new c;return require(["application/sniff!legendlayers?esri/dijit/LayerList"],n.hitch(this,function(i){if(!i)return void e.resolve();var t=document.createElement("link");t.type="text/css",t.href="//js.arcgis.com/3.21/esri/dijit/LayerList/css/LayerList.css",t.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(t),new i({map:this.map,showLegend:!0,layers:u.getLayerList(this.config.response)},d.create("div",{},p.byId("legend").domNode)).startup(),e.resolve()})),e.promise},_addLegend:function(){var e=new c;return require(["application/sniff!legend?esri/dijit/Legend"],n.hitch(this,function(i){if(!i)return void e.resolve();new i({map:this.map,layerInfos:u.getLegendLayers(this.config.response)},d.create("div",{},p.byId("legend").domNode)).startup(),e.resolve()})),e.promise},_setupFind:function(){var e=new c;return this.config.find||this.config.feature||null!==this.config.customUrlLayer.id&&this.config.customUrlLayer.fields.length>0&&null!==this.config.customUrlParam?require(["esri/dijit/Search","esri/urlUtils"],n.hitch(this,function(i,t){if(!i&&!t)return void e.resolve();var a=null,s=null,r=null,c=null;if(null!==this.config.customUrlLayer.id&&this.config.customUrlLayer.fields.length>0&&null!==this.config.customUrlParam){var l=t.urlToObject(document.location.href);l.query=l.query||{},l.query=f.stripTags(l.query);var h=null;for(var d in l.query)l.query.hasOwnProperty(d)&&d.toUpperCase()===this.config.customUrlParam.toUpperCase()&&(h=d);if(c=l.query[h],v=this.map.getLayer(this.config.customUrlLayer.id)){var p=this.config.customUrlLayer.fields[0].fields;r={exactMatch:!0,outFields:["*"],featureLayer:v,displayField:p[0],searchFields:p}}}if(this.config.feature&&(a=decodeURIComponent(this.config.feature))){var g=a.split(";");if(g.length&&3!==g.length&&(g=a.split(",")),(a=g)&&a.length&&3===a.length){var u=a[0],m=a[1],b=a[2],v=null;v=this.map.getLayer(u),v&&(r={exactMatch:!0,outFields:["*"],featureLayer:v,displayField:m,searchFields:[m]},c=b)}}this.config.find&&(s=decodeURIComponent(this.config.find),c=s);var y=new i({map:this.map,zoomScale:this.config.customUrlLayerZoomScale||1e3});y.startup(),r&&y.set("sources",[r]),y.startup(),y.search(c).then(n.hitch(this,function(e){if(this.config.customUrlLayerZoomScale){var i=e[0];if(i){var t=i[0];t&&t.extent&&this.map.setScale(this.config.customUrlLayerZoomScale).then(n.hitch(this,function(){this.map.centerAt(t.extent.getCenter())}))}}o.once(this.map.infoWindow,"hide",n.hitch(this,function(){y.clear(),y.destroy()}))})),e.resolve()})):e.resolve(),e.proise},_setupSearch:function(){var e=new c;return require(["application/sniff!search?esri/dijit/Search","application/sniff!search?esri/tasks/locator","application/sniff!search?application/SearchSources"],n.hitch(this,function(i,t,o){if(!i&&!t&&!o)return void e.resolve();var a={map:this.map,useMapExtent:this.config.searchextent,itemData:this.config.response.itemInfo.itemData};this.config.searchOptions&&this.config.searchOptions.sources?(this.config.searchOptions.hasOwnProperty("enableSearchingAll")&&(a.enableSearchingAll=!0),a.applicationConfiguredSources=this.config.searchOptions.sources,this.config.searchOptions.hasOwnProperty("activeSourceIndex")&&(a.activeSourceIndex=this.config.searchOptions.activeSourceIndex)):a.geocoders=this.config.helperServices.geocode||[];var n=new o(a),s=n.createOptions();s.enableButtonMode=!0,s.expanded=!0;var r=new i(s,d.create("div",{id:"search",className:"simpleGeocoder"},"mapDiv"));if(h.add(r.domNode,"simpleGeocoder"),r.startup(),this.config.find){r.set("value",this.config.find);var c=r.activeSourceIndex;r.set("activeSourceIndex","all"),r.search(this.config.find).then(function(){r.set("activeSourceIndex",c)})}e.resolve()})),e.promise},_addBasemapGallery:function(){var e=new c;return require(["application/sniff!basemap_gallery?esri/dijit/BasemapGallery"],n.hitch(this,function(i){if(!i)return void e.resolve();var t={showArcGISBasemaps:!0,bingMapsKey:this.config.orgInfo.bingKey||"",portalUrl:this.config.sharinghost,basemapsGroup:this._getBasemapGroup(),map:this.map},a=null,s=d.create("div",{id:"gallery_container"},"mapDiv");this.gallery_container=s,d.create("div",{class:"arrow_box",innerHTML:"<div class='basemap_title'>"+this.config.i18n.tools.basemap.title+"</div><span tabindex='0' role='button' aria-label='"+this.config.i18n.tools.basemap.close+"' id='esri-icon-close' class='esri-icon-close'></span><div id='full_gallery'></div>"},s);var r=d.create("div",{class:"icon-basemap-container active-toggle",tabindex:"0","aria-label":this.config.i18n.tools.basemap.label,role:"button",click:n.hitch(this,this._displayBasemapContainer)},this.map.id+"_root");d.create("div",{class:"icon-basemap",title:this.config.i18n.tools.basemap.label},r),this.config.zoom&&this.config.zoom_position&&(h.add(r,"embed-"+this.config.zoom_position),h.add(this.gallery_container,"embed-"+this.config.zoom_position)),a=new i(t,"full_gallery"),a.startup();var c=document.getElementById("esri-icon-close");c&&o(c,"click",n.hitch(this,function(){this._displayBasemapContainer()})),this._displayBasemapContainer(),e.resolve()})),e.promise},_addBasemapToggle:function(){var e=new c;return require(["application/sniff!basemap_toggle?esri/dijit/BasemapToggle","application/sniff!basemap_toggle?esri/basemaps"],n.hitch(this,function(i,t){if(!i&&!t)return void e.resolve();if(!this.config.basemap_gallery){var a=d.create("div",{},"mapDiv"),s=new i({map:this.map,basemap:this.config.alt_basemap||"satellite"},a),r=[],c=this.map.getLayersVisibleAtScale(this.map.getScale());if(c)for(var l=0;l<c.length;l++)if(c[l]._basemapGalleryLayerType){var p=this.map.getLayer(c[l].id);p&&r.push(p)}if(o.once(this.map,"basemap-change",n.hitch(this,function(){if(r&&r.length)for(var e=0;e<r.length;e++)r[e].setVisibility(!1)})),this.config.response&&this.config.response.itemInfo&&this.config.response.itemInfo.itemData&&this.config.response.itemInfo.itemData.baseMap){var g=this.config.response.itemInfo.itemData.baseMap;if("World Dark Gray Base"===g.title&&(g.title="Dark Gray Canvas"),g.title)for(var f in t)g.title===this._getBasemapName(f)&&(s.defaultBasemap=f,"dark-gray"===f&&this.map.layerIds&&this.map.layerIds.length>0&&(this.map.basemapLayerIds=this.map.layerIds.slice(0),this.map._basemap="dark-gray"))}this.config.zoom&&this.config.zoom_position&&h.add(s.domNode,"embed-"+this.config.zoom_position),this.config.scale&&h.add(s.domNode,"scale"),s.startup(),e.resolve()}})),e.promise},loadMapWidgets:function(){var e=[];if(e.push(n.hitch(this,this._addScalebar())),e.push(n.hitch(this,this._addZoom())),!1===this.config.zoom&&h.add(document.body,"no-zoom"),this.config.zoom&&this.config.zoom_position&&"top-left"!==this.config.zoom_position&&h.add(document.body,"no-zoom"),e.push(this._addLayerList()),e.push(this._addLegend()),this.config.details){var i={title:this.config.response.itemInfo.item.title,description:this.config.response.itemInfo.item.description||this.config.i18n.tools.details.error};p.byId("details").set("content",n.replace("<div class='map-title'>{title}</div><div class='map-details'>{description}</div>",i))}if(e.push(n.hitch(this,this._setupFind())),e.push(n.hitch(this,this._setupSearch())),e.push(n.hitch(this._addBasemapGallery())),e.push(n.hitch(this,this._addBasemapToggle())),this.config.active_panel){var t=p.byId("tabContainer");if(t){p.byId(this.config.active_panel)&&t.selectChild(this.config.active_panel)}}var o=p.byId("border_container");o&&o.resize(),l(e).then(n.hitch(this,function(){if(this.config.sharedThemeConfig&&this.config.sharedThemeConfig.attributes&&this.config.sharedThemeConfig.attributes.theme){var e=this.config.sharedThemeConfig.attributes;this.config.buttonColor=e.theme.text.color,this.config.buttonBackground=e.theme.body.bg}var i=null;if(this.config.buttonColor){var t=f.substitute({theme:this.config.theme,color:this.config.buttonColor},".${theme} .menu-button{color:${color}}.${theme} .${theme} .vertical-line{background:${color};}.esriPopup div.titlePane, .esriPopup .titleButton{color:${color};}");i=i?i+=t:t}if(this.config.buttonBackground){var o=f.substitute({theme:this.config.theme,background:this.config.buttonBackground},".esriPopup div.titlePane{background-color:${background}}.${theme} .menu-button{background-color:${background};}.vertical-line{background-color:${background} !important;}");i=i?i+=o:o}if(this.config.headerBackground){var a=f.substitute({theme:this.config.theme,backgroundColor:this.config.headerBackground,contrastColor:this._calculateColorLuminance(this.config.headerBackground,.2)},".calcite.${theme} .dijitTab{background:${backgroundColor};}.calcite.${theme} .dijitTabChecked{background:${contrastColor};}");i=i?i+=a:a}if(this.config.headerColor){var n=".dijitTab .tabLabel{ color:"+this.config.headerColor+";}";i=i?i+=n:n}if(this.config.bodyBackground){var s=f.substitute({background:this.config.bodyBackground,theme:this.config.theme},".calcite.${theme} .dijitTabPaneWrapper{background:${background};}.${theme} .esriLayerList .esriContainer{background-color:${background};} .esriLayerList .esriContainer{background-color:${background};}");i=i?i+=s:s}if(this.config.bodyColor){var r=f.substitute({color:this.config.bodyColor,theme:this.config.theme},".${theme} .dijitTabPane{color:${color};} .dijitTabPane{color:${color};} .esriLayerList .esriToggleButton{color:${color};}.esriLayerList .esriLabel{color:${color};}.calcite .esriLegendLayer{color:${color};} .esriLayerList .esriContainer{color:${color};}.calcite .esriLegendServiceLabel, .calcite .esriLegendLayerLabel{color:${color};} .no-select{color:${color};}");i=i?i+=r:r}if(i){var c=document.createElement("style");c.appendChild(document.createTextNode(i)),document.head.appendChild(c)}}))},_calculateColorLuminance:function(e,i){e=new String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),i=i||0;var t,o,a="#";for(o=0;o<3;o++)t=parseInt(e.substr(2*o,2),16),t=Math.round(Math.min(Math.max(0,t+255*i),255)).toString(16),a+=("00"+t).substr(t.length);return a},_adjustPopupSize:function(){if(this.map){var e=t.getContentBox(this.map.container),i=270,o=300,a=Math.round(.5*e.w),n=Math.round(.35*e.h);a<i&&(i=a,this._drawer&&(i=270)),n<o&&(o=n),this.map.infoWindow.resize(i,o)}},_displayBasemapContainer:function(){var e=null,i=r(".basemap_gallery");e=i&&i.length>0?i[0]:this.gallery_container,h.toggle(r(".icon-basemap-container")[0],"active-toggle"),g.toggle(e)},_getBasemapName:function(e){var i="Streets";return"dark-gray"===e||"dark-gray-vector"===e?i="Dark Gray Canvas":"gray"===e||"gray-vector"===e?i="Light Gray Canvas":"hybrid"===e?i="Imagery with Labels":"national-geographic"===e?i="National Geographic":"oceans"===e?i="Oceans":"osm"===e?i="OpenStreetMap":"satellite"===e?i="Imagery":"streets"===e||"streets-vector"===e?i="Streets":"streets-navigation-vector"===e?i="World Navigation Map":"streets-night-vector"===e?i="World Street Map (Night)":"streets-relief-vector"===e?i="World Street Map (with Relief)":"terrain"===e?i="Terrain with Labels":"topo"!==e&&"topo-vector"!==e||(i="Topographic"),i},_createWebMap:function(e,i){var t=new m({titleInBody:!0},d.create("div"));if(h.add(document.body,this.config.theme),h.add(t.domNode,this.config.theme),i=i||{},this.config.disable_nav&&(this.config.zoom=!1),i.mapOptions.slider=this.config.zoom,i.mapOptions.sliderPosition=this.config.zoom_position,i.mapOptions.infoWindow=t,this.config.sharedThemeConfig&&this.config.sharedThemeConfig.attributes&&this.config.sharedThemeConfig.attributes.theme){var o=this.config.sharedThemeConfig.attributes;this.config.logoimage=o.layout.header.component.settings.logoUrl||o.theme.logo.small||null}return i.mapOptions.logo=null===this.config.logoimage,this.config.disable_scroll&&(i.mapOptions.smartNavigation=!1),u.createMap(e,"mapDiv",{mapOptions:i.mapOptions||{},usePopupManager:!0,layerMixins:this.config.layerMixins||[],editable:this.config.editable,bingMapsKey:this.config.orgInfo.bingKey||""}).then(n.hitch(this,function(e){if(this.map=e.map,i.mapOptions.center&&i.mapOptions.extent&&this.map.centerAt(i.mapOptions.center),document.title=e.itemInfo.item.title,this.config.previewImage){var t=document.getElementById("previewImage");h.add(t,"fade-out")}return this.config.response=e,this._adjustPopupSize(),this.config.disable_nav&&(this.map.disableMapNavigation(),this.map.disableKeyboardNavigation(),this.map.disablePan(),this.map.disableRubberBandZoom(),this.map.disableScrollWheelZoom()),this.config.logoimage&&r(".esriControlsBR").forEach(n.hitch(this,function(e){var i=null;this.config.logolink&&this._validateUrl(this.config.logolink)&&(i=d.create("a",{href:this.config.logolink,target:"_blank"},e)),d.create("img",{src:this.config.logoimage,class:"logo"},i||e)})),this.config.disable_scroll&&this.map.disableScrollWheelZoom(),i.markerGraphic&&require(["esri/layers/GraphicsLayer"],n.hitch(this,function(e){var t=new e;this.map.addLayer(t),t.add(i.markerGraphic),i.markerGraphic.infoTemplate&&(this.map.infoWindow.setFeatures([i.markerGraphic]),this.map.infoWindow.show(i.markerGraphic.geometry))})),h.remove(document.body,"app-loading"),this.config.popup_sidepanel&&(this.map.infoWindow.set("popupWindow",!1),this._initializeSidepanel()),this.loadMapWidgets(),e}),this.reportError)},_displayPopupContent:function(e,t,o){if(e){var a=e.getContent();p.byId("info_content").set("content",a),t&&o&&i.set(document.getElementById("nav_count"),"innerHTML",t+"/"+o)}},_initializeSidepanel:function(){var e=this.map.infoWindow,t=document.getElementById("prev_nav"),a=document.getElementById("next_nav"),s=document.getElementById("popupNav"),c=document.getElementById("selectCount");e.on("selection-change",n.hitch(this,function(){e.count>1?(this._displayPopupContent(e.getSelectedFeature(),e.selectedIndex+1,e.count),i.set(t,"disabled",!1),i.set(a,"disabled",!1),0===e.selectedIndex?i.set(t,"disabled",!0):e.selectedIndex+1===e.count&&i.set(a,"disabled",!0)):this._displayPopupContent(e.getSelectedFeature())})),e.on("clear-features",n.hitch(this,function(){g.hide(s),p.byId("info_content").set("content",""),i.set(t,"disabled",!1),i.set(a,"disabled",!1),document.getElementById("nav_count").innerHTML="",g.show(c)})),e.on("set-features",n.hitch(this,function(){p.byId("tabContainer").selectChild("popup");var o=r(".drawer-open");o&&0===o.length&&document.getElementById("toggle_button").click(),e.features&&e.features.length>1?(this._displayPopupContent(e.getSelectedFeature(),e.selectedIndex+1,e.count),g.show(s),i.set(a,"disabled",!1),i.set(t,"disabled",!0)):(g.hide(s),this._displayPopupContent(e.getSelectedFeature())),g.hide(c),this._drawer.resize()})),o(t,"click",function(){e.selectPrevious()}),o(a,"click",function(){e.selectNext()})},_getBasemapGroup:function(){var e=null;return this.config.basemapgroup&&this.config.basemapgroup.title&&this.config.basemapgroup.owner?e={owner:this.config.basemapgroup.owner,title:this.config.basemapgroup.title}:this.config.basemapgroup&&this.config.basemapgroup.id&&(e={id:this.config.basemapgroup.id}),e},_supportsPagination:function(e){var i;return e.locator?i=!0:e.featureLayer&&e.featureLayer.advancedQueryCapabilities&&e.featureLayer.advancedQueryCapabilities.supportsPagination&&(i=!0),i},_validateUrl:function(e){return!!/^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/.test(e)}})});